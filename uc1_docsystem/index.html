<html>
<head>
<style>
svg {
  border: 1px solid #999;
  overflow: hidden;
}

.node {
  white-space: nowrap;
}

.node rect,
.node circle,
.node ellipse {
  stroke: #333;
  fill: #fff;
  stroke-width: 1.5px;
}

.cluster rect {
  stroke: #333;
  fill: #000;
  fill-opacity: 0.1;
  stroke-width: 1.5px;
}

.edgePath path.path {
  stroke: #333;
  stroke-width: 1.5px;
  fill: none;
}
</style>	
</head>	
<body>
<h1 id=title></h1>
<svg width=800 height=400>
  <g/>
</svg>
<ol id=steps></ol>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://dagrejs.github.io/project/graphlib-dot/v0.6.3/graphlib-dot.js"></script>
<script src="https://dagrejs.github.io/project/dagre/latest/dagre.min.js"></script>
<script src="https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.min.js"></script>	
<script>
const Http = new XMLHttpRequest();
const url='http://localhost:2904/models/com.strumenta.workflow.sandbox.examples/6439756077573116110';
Http.open("GET", url);
Http.send();

Http.onreadystatechange = (e) => {
  if (window.done) {
  	return
  }		
  	var text = Http.responseText;
  	if (text.length < 2) return;
  	var data = JSON.parse(Http.responseText).value;
  	window.data = data;

	document.getElementById("title").innerHTML = data.properties["name"];

	var idsToIndex = {};
	for (var i=0;i<data.children.length;i++) {
		var c = data.children[i];
		idsToIndex[c.id.regularId] = i;
	}

	var g = new dagre.graphlib.Graph();
	g.setGraph({rankdir:"LR"});
	g.setDefaultEdgeLabel(function() { return {}; });	

	for (var i=0;i<data.children.length;i++) {
		var newLi = document.createElement("li");
		var c = data.children[i];
		if (c.concept == "com.strumenta.workflow.Start") {
			newLi.innerHTML = "We <i>start</i> by going to step " + (idsToIndex[c.children[0].refs.target.id.regularId]+1);
			g.setNode("node_"+c.id.regularId,    { shape: "circle", label: "" });
		} else if (c.concept == "com.strumenta.workflow.Action") {
			newLi.innerHTML = "We <b>do</b>  " + c.properties["description"] + ". Then we go to step " + (idsToIndex[c.children[0].refs.target.id.regularId]+1);
			g.setNode("node_"+c.id.regularId,    { label: c.properties["description"],  width: 80, height: 10 });
		} else if (c.concept == "com.strumenta.workflow.End") {
			g.setNode("node_"+c.id.regularId,    { shape: "circle", label: "", style: "fill: #333" });
			newLi.innerHTML = "With this we consider the workflow completed.";
		} else {
			newLi.innerHTML = "unknown step";
		}
		for (var li=0;li<c.children.length;li++) {
			var l = c.children[li];
			var targetId = l.refs["target"].id.regularId;
			g.setEdge("node_"+c.id.regularId,   "node_"+targetId);
		}
		document.getElementById("steps").appendChild(newLi);
	}
	var svg = d3.select("svg"),
    inner = d3.select("svg g"),
    zoom = d3.zoom().on("zoom", function() {
      inner.attr("transform", d3.event.transform);
    });
	svg.call(zoom);

	var render = dagreD3.render();

	d3.select("svg g").call(render, g);
	window.done = true;
}
</script>
</body>
</html>